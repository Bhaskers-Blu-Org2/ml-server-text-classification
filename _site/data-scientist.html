<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="images/favicon.png">
    <title>For the images Scientist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Use SQL Server 2017 + ML Services with Python to execute a transfer learning algorithm to detect image similarity.">
    <meta name="author" content="Microsoft">

    <!-- Le styles -->
    <link href="stylesheets/bootstrap.min.css" rel="stylesheet"/>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="stylesheets/mystyles.css">

  </head>
  <body> 
    <div class="container">
      <div class="row">
        <div class="col-sm-9">
          <div class="jumboton teal">
            <h1>Image Similarity</h1>
            <p>Implemented with Microsoft Machine Learning Services</p>
          </div>
              <div class="content">
                <h2 id="for-the-data-scientist---develop-with-r-or-python">For the Data Scientist - Develop with R or Python</h2>
<hr />

<div class="row">
    <div class="col-md-6">
        <div class="toc">
            <li><a href="#first">Image Similarity</a></li>
            <li><a href="#system-requirements">System Requirements</a></li>
            <li><a href="#data">Data</a></li>
            <li><a href="#workflow">Workflow</a></li>
            <li><a href="#step1">Step 1: Loading the data to SQL Server     </a></li>
            <li><a href="#step2">Step 2: Create features on the fly for the training set and train the model</a></li>
            <li><a href="#step3">Step 3: Create features on the fly for the testing set, make predictions, and evaluate the model</a></li>
            <li><a href="#template-contents">Template Contents</a></li>
        </div>
    </div>
    <div class="col-md-6">
        Microsoft Machine Learning Services provide an extensible, scalable platform for integrating machine learning tasks and tools with the applications that consume machine learning services. It includes a database service that runs outside the SQL Server process and communicates securely with R and Python.
        <p>
       This solution package shows how to pre-process data (cleaning and feature engineering), train prediction models, and perform scoring on the SQL Server machine in either R or Python.</p>
    </div>
</div>

<p>When a customer sends a support ticket, it is important to route it to the right team in order to examine the issue and solve it in the fastest way possible. We use sample data containing a Subject, a Text, and a Label to build a machine learning model that can predict a label for new incoming data.</p>

<p>This solution takes advantage of the power of SQL Server and RevoScaleR and RevoScalePy. The tables are all stored in a SQL Server, and most of the computations are done by loading chunks of data in-memory instead of the whole dataset.</p>

<p>All these steps can be executed in a R or Python IDE, and are then operationalized into SQL Server Stored Procedures.  Scoring of new data is then performed in SQL Server.</p>

<p>Scientists who are testing and developing solutions can work from the convenience of their preferred IDE on their client machine, while <a href="https://msdn.microsoft.com/en-us/library/mt604885.aspx">setting the computation context to SQL</a> (see  <strong>R</strong> or <strong>Python</strong> folder for code).  They can also deploy the completed solutions to SQL Server 2017 by embedding calls to R or Python in stored procedures. These solutions can then be further automated by the use of SQL Server Integration Services and SQL Server agent: a PowerShell script (.ps1 file) automates the running of the SQL code.</p>

<p><a name="first"></a></p>

<h2 id="image-similarity">Image Similarity</h2>
<hr />

<p>To try this out yourself, see the <a href="quick.html">Quick Start</a> section on the main page.</p>

<p>This page describes what happens in each of the steps.</p>

<h2 id="system-requirements">System Requirements</h2>
<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>Running the R or Pythong scripts requires the following:
</code></pre>
</div>

<ul>
  <li>SQL server 2017 with RevoscalePy (version 9.2) and MicrosoftML (version 1.5.0) installed and configured;</li>
  <li>The SQL user name and password, and the user configured properly to execute R scripts in-memory;</li>
  <li>SQL Database which the user has write permission and execute stored procedures;</li>
  <li>For more information about Machine Learning Services in SQL Server, please visit: <a href="https://msdn.microsoft.com/en-us/library/mt604847.aspx">https://msdn.microsoft.com/en-us/library/mt604847.aspx</a></li>
</ul>

<p>This code was tested using SQL Server 2017, and assumes that SQL Server with ML Services was installed. The installation process can be found <a href="setupSQL.html">here</a>.</p>

<h2 id="data">Data</h2>
<hr />

<p>This solution uses a preprocessed version of the <a href="http://scikit-learn.org/stable/datasets/twenty_newsgroups.html">NewsGroups20</a>, containing a Subject, a Text, and a Label (20 classes). It has a similar structure to a support ticket data set which would also have two data fields: Title, and Problem description. Thus, you can easily change this solution to use your support ticket data simply by providing the same structure for the test and train datasets.</p>

<p><a href="tables.html">Click here</a> to view the SQL database tables created in this solution.</p>

<h2 id="workflow">Workflow</h2>

<p>The file <strong>R/modeling_main.R</strong> or <strong>Python/modeling_main.py</strong> enables the user to define the input and perform all the steps. Inputs are: paths to the raw data files, database name, server name, username and password.
The database is created if necessary, and the connection string as well as the SQL compute context are defined.</p>

<p>The steps below describe the process which applies identically to the R or Python code.</p>

<p><a name="step1"></a></p>

<h3 id="step-1-loading-the-data-to-sql-server">Step 1: Loading the data to SQL Server</h3>
<hr />

<p>The NewsGroups20 data has already been downloaded and preprocessed in R and Python, then saved to disk. The raw data has been uploaded to SQL Server. It consists of:</p>

<ul>
  <li>News_Train: Training set.</li>
  <li>News_Test: Testing set.</li>
  <li>Label_Names: Link between the Label integers and the Label names.</li>
</ul>

<p>The preprocessing consists of:</p>

<ul>
  <li>Separating the Subject from the rest of the text in the text variable. This creates two separate text variables: “Subject” and “Text”. In this context, the data set has a similar structure to a Support Ticket classification problem.</li>
  <li>Remove unnecessary words or special characters (“\t”, “\n” etc.).</li>
  <li>Remove rows with an empty text body.</li>
  <li>Add an Id variable.</li>
</ul>

<p><a name="step2"></a></p>

<h3 id="step-2-create-features-on-the-fly-for-the-training-set-and-train-the-model">Step 2: Create features on the fly for the training set and train the model</h3>
<hr />

<p>For feature engineering, we want to featurize the text variables in the data: Subject and Text. 
The Subject and Text are featurized separately in order to give to the words in the Subject the same weight as those in the Text. This approach is also applicable to Support ticket Classification problems.</p>

<p>For each of the Subject and the Text separately, we:</p>

<ul>
  <li>Remove stopwords, diacritics, punctuation and numbers.</li>
  <li>Change capital letters to lower case.</li>
  <li>Hash the different words and characters.</li>
</ul>

<p>The parameters or options can be further optimized by parameter sweeping.</p>

<p>This is done by following these steps:</p>

<ol>
  <li>
    <p>Get the factor levels of the label in the order of encounter based on the Id, serialize them, and save them to SQL Server for future use.</p>
  </li>
  <li>
    <p>Define the text transformation to be used to generate features, in the form of a list. It will be applied on the fly during training and testing.</p>
  </li>
  <li>
    <p>Train a multiclass logistic regression on the training set, using the text transformation list.</p>
  </li>
</ol>

<p>The model trained is then serialized and saved to SQL Server for future use.</p>

<p><a name="step3"></a></p>

<h3 id="step-3-create-features-on-the-fly-for-the-testing-set-make-predictions-and-evaluate-the-model">Step 3: Create features on the fly for the testing set, make predictions, and evaluate the model</h3>
<hr />

<p>In the same fashion, we call the prediction function on the testing set News_Test. It makes predictions while featurizing the text variables (Subject and Text) separately on the fly. This will automatically use the same text transformation as in the training, encoded in logistic_model.</p>

<p>Once we get the predictions, we perform an inner join with the “Label_Names” table in order to get the names of the predicted labels.</p>

<p>Finally, we compute performance metrics in order to evaluate the model for this multi-class classification problem.</p>

<ul>
  <li>Micro Average Accuracy: It is the overall accuracy, which corresponds to the number of correct class predictions divided by the total number of observations in the testing set (ie. rate of correct classification). In this sense, performing poorly on some rare classes but very accurately predicting the rest might still give a good result.</li>
  <li>Macro Average Accuracy: It corresponds to the average of the per-class accuracy. In this sense, it treats all the classes equally, even if some of the classes are rare.</li>
</ul>

<p>These two metrics should thus be analyzed together, especially in the case of class imbalances.</p>

<h2 id="template-contents">Template Contents</h2>
<hr />

<p><a href="contents.html">View the contents of this solution template</a>.</p>

<p>To try this out yourself:</p>

<ul>
  <li>View the <a href="quick.html">Quick Start</a>.</li>
</ul>

<p><a href="index.html">&lt; Home</a></p>

              </div>  
          </div><!--/col -->

        <div class="col-sm-3 sidebar-offcanvas" id="sidebar">
          <img  src="images/TextAnalysis.png">
          <div class="list-group">
          <a href="index.html" class="list-group-item">Home</a>
					<a href="data-scientist.html" class="list-group-item">For the Data Scientist</a>
          <a href="dba.html" class="list-group-item">For the Database Analyst</a>
					<a href="quick.html" class="list-group-item">Quick Start</a>
				  </div>
        <hr />
            <div class="center">
            <a  class="btn btn-large btn-info" href="https://github.com/Microsoft/ml-server-image-similarity">
            View On <strong>GitHub</strong></a>
            </div>
            <hr />
            <p class="details">Other Links</p>
              <div class="toc">
                <li><a href="contents.html">Packet Contents</a></li>
                <li><a href="sitemap.html">Site Map</a></li>
                <li><a href="https://aka.ms/ml-server-samples">Other ML Server Solutions</a></li>

            </div>
          </div><!--/col -->
      </div><!-- /row -->

<div class="row">
  <hr />
      <footer>
        <p> 
This project has adopted the <a href="https://opensource.microsoft.com/codeofconduct/">Microsoft Open Source Code of Conduct</a>. For more information see the <a href="https://opensource.microsoft.com/codeofconduct/faq/">Code of Conduct FAQ</a> or contact <a href="mailto:opencode@microsoft.com">opencode@microsoft.com</a> with any additional questions or comments.</p>
        <p><small>Hosted on GitHub Pages</small> </p>
      </footer>
  </div>
  
</div><!-- /container -->

<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>


<!-- <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88854735-5', 'auto');
  ga('send', 'pageview');

</script> -->
    

  </body>
</html>